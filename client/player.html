<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Player Report | FootySquad</title>
    <link rel="stylesheet" href="index.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--glass-border);
            gap: 1rem;
        }

        .stat-value {
            font-weight: 800;
            color: var(--accent-color);
            text-align: right;
            word-break: break-word;
        }

        .pitch-container {
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1.5/1;
            background: #2e4d35;
            border-radius: 12px;
            position: relative;
            margin: 0 auto;
            border: 2px solid rgba(255, 255, 255, 0.2);
            overflow: hidden;
        }

        .pitch-line {
            position: absolute;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .mid-line {
            height: 100%;
            left: 50%;
            border-left: 2px solid rgba(255, 255, 255, 0.3);
        }

        .center-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .penalty-box {
            width: 15%;
            height: 40%;
            top: 30%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .penalty-box.left {
            left: 0;
            border-left: none;
        }

        .penalty-box.right {
            right: 0;
            border-right: none;
        }

        .heatmap-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .heatmap-container svg {
            width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .radar-container {
            width: 100%;
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body>
    <div class="bg-container">
        <div class="bg-glow"></div>
    </div>

    <main>
        <header>
            <div class="logo">FOOTYSQUAD</div>
            <nav>
                <a href="/" class="btn" style="color: var(--text-secondary);">Back to Search</a>
            </nav>
        </header>

        <div class="profile-header-card">
            <div class="header-main">
                <div class="header-left">
                    <img id="player-img" src="" class="profile-circle">
                    <div class="name-container">
                        <h1 id="player-name">Loading Profile...</h1>
                        <div class="team-info">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
                            </svg>
                            <span id="player-team">Arsenal</span>
                        </div>
                    </div>
                </div>

                <div class="header-right">
                    <button class="compare-btn">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" />
                            <circle cx="9" cy="7" r="4" />
                            <path d="M22 21v-2a4 4 0 0 0-3-3.87" />
                            <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                        </svg>
                        COMPARE
                    </button>
                    <div class="icon-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polygon
                                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                        </svg>
                    </div>
                    <div class="icon-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="16 18 22 12 16 6" />
                            <polyline points="8 6 2 12 8 18" />
                        </svg>
                    </div>
                </div>
            </div>

            <div class="header-meta-bar">
                <div class="meta-item">
                    <img id="player-flag-img" src="https://flagcdn.com/w40/es.png" class="flag-circle">
                    <span id="player-nation">Spain</span>
                </div>
                <div class="meta-item">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8" />
                        <path d="M4 16s.5-1 2-1 2.5 2 4 2 2.5-2 4-2 2.5 2 4 2 2-1 2-1" />
                        <path d="M2 21h20" />
                        <path d="M7 8v3" />
                        <path d="M12 8v3" />
                        <path d="M17 8v3" />
                        <path d="M7 4h.01" />
                        <path d="M12 4h.01" />
                        <path d="M17 4h.01" />
                    </svg>
                    <span id="player-dob">30 March 1986 (39)</span>
                </div>
                <div class="meta-item">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10" />
                        <circle cx="12" cy="12" r="6" />
                        <circle cx="12" cy="12" r="2" />
                    </svg>
                    <span id="player-pos-meta">Defender</span>
                </div>
                <div class="meta-item">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M7 18v-6a5 5 0 0 1 10 0v6" />
                        <path d="M12 12v10" />
                        <path d="M18 22h-12" />
                        <circle cx="12" cy="7" r="3" />
                    </svg>
                    <span id="player-height">184 cm</span>
                </div>
                <div class="meta-item">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path
                            d="M4 16v-4.5c0-1.5 1-2.5 2-3.5 1-1 2-1.5 4-2 2.5-.5 5 0 7 1.5 1.5 1 3 2.5 3 4.5v4c0 1-1 2-2 2h-12c-1 0-2-1-2-2z" />
                        <path d="M8 12h4" />
                        <path d="M8 14h4" />
                        <path d="M4 16l-2 2" />
                        <path d="M20 16l2 2" />
                    </svg>
                    <span id="player-foot">Right</span>
                </div>
            </div>
        </div>

        <section class="glass-card" style="margin-top: 2rem;">
            <h2 style="margin-bottom: 1.5rem; text-align: center;">Summary (last 12 months)</h2>
            <div id="rating-graph-container"
                style="width: 100%; min-height: 250px; display: flex; align-items: center; justify-content: center;">
                <p style="color: var(--text-secondary);">Loading Performance Chart...</p>
            </div>
            <div
                style="display: flex; justify-content: center; gap: 2rem; margin-top: 1rem; color: var(--text-secondary); font-size: 0.85rem;">
                <span style="display: flex; align-items: center; gap: 0.5rem;">ðŸŸ¢ Click graph to swap values</span>
                <span style="display: flex; align-items: center; gap: 0.5rem;">ðŸŸ£ Transfer/Loan</span>
            </div>
        </section>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
            <section class="glass-card">
                <h2 style="margin-bottom: 1.5rem;">Season Statistics</h2>
                <div id="stats-container" class="stats-grid">
                    <!-- Stats will load here -->
                </div>
                <div class="radar-container"
                    style="margin-top: 2rem; border-top: 1px solid var(--glass-border); padding-top: 2rem;">
                    <canvas id="player-radar"></canvas>
                </div>
            </section>

            <section class="glass-card">
                <h2 style="margin-bottom: 1.5rem; text-align: center;">Season Heatmap</h2>
                <div class="pitch-container" id="heatmap-pitch" style="background: transparent; border: none;">
                    <div id="heatmap-svg-container" class="heatmap-container">
                        <p style="color: var(--text-secondary);">Generating Matplotlib Heatmap...</p>
                    </div>
                </div>
                <p style="text-align: center; color: var(--text-secondary); margin-top: 1rem; font-size: 0.9rem;">
                    Positional Heatmap based on Season Performance
                </p>
                <div style="display: flex; justify-content: center; gap: 0.5rem; margin-top: 1.5rem; flex-wrap: wrap;">
                    <div
                        style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: var(--text-secondary);">
                        <div style="width: 12px; height: 12px; background: #3F6B3C; border-radius: 2px;"></div> Low
                    </div>
                    <div
                        style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: var(--text-secondary);">
                        <div style="width: 12px; height: 12px; background: #C7D84B; border-radius: 2px;"></div>
                    </div>
                    <div
                        style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: var(--text-secondary);">
                        <div style="width: 12px; height: 12px; background: #FFD84D; border-radius: 2px;"></div>
                    </div>
                    <div
                        style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: var(--text-secondary);">
                        <div style="width: 12px; height: 12px; background: #FF9F1C; border-radius: 2px;"></div>
                    </div>
                    <div
                        style="display: flex; align-items: center; gap: 0.25rem; font-size: 0.75rem; color: var(--text-secondary);">
                        <div style="width: 12px; height: 12px; background: #FF3B30; border-radius: 2px;"></div> High
                    </div>
                </div>
            </section>
        </div>

        <footer>
            <p>&copy; 2026 FootySquad Project - Data Collecting Techniques</p>
        </footer>
    </main>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const playerName = urlParams.get('name');
        const playerImg = urlParams.get('img');
        const playerPos = urlParams.get('pos');
        const playerNum = urlParams.get('num');
        const profileUrl = urlParams.get('url');

        document.getElementById('player-name').textContent = playerName;
        document.getElementById('player-img').src = playerImg;
        document.getElementById('player-team').textContent = "Arsenal FC"; // Default, could be refined
        document.getElementById('player-pos-meta').textContent = playerPos;

        async function loadDetails() {
            const container = document.getElementById('stats-container');

            try {
                const response = await fetch(`/api/player_details?url=${encodeURIComponent(profileUrl)}`);
                const stats = await response.json();

                // Populate Header Metadata with Enriched Data
                const nation = stats['Nationality'] || stats['Country'] || "Unknown";
                const age = stats['Age'] || stats['Date of birth'] || "-";
                const height = stats['Height'] || "-";
                const foot = stats['Preferred foot'] || "-";

                document.getElementById('player-nation').textContent = nation;
                document.getElementById('player-dob').textContent = age;
                document.getElementById('player-height').textContent = height;
                document.getElementById('player-foot').textContent = foot;

                // Map nation to Flag Code (Expanded)
                const nationMap = {
                    'Spain': 'es', 'England': 'gb-eng', 'Germany': 'de', 'France': 'fr',
                    'Italy': 'it', 'Portugal': 'pt', 'Brazil': 'br', 'Argentina': 'ar',
                    'Norway': 'no', 'Denmark': 'dk', 'Sweden': 'se', 'Colombia': 'co',
                    'Belgium': 'be', 'Netherlands': 'nl', 'Croatia': 'hr', 'Uruguay': 'uy',
                    'Nigeria': 'ng', 'Senegal': 'sn', 'Egypt': 'eg', 'Japan': 'jp',
                    'South Korea': 'kr', 'USA': 'us', 'Canada': 'ca', 'Australia': 'au'
                };
                const code = nationMap[nation] || 'un';
                document.getElementById('player-flag-img').src = `https://flagcdn.com/w40/${code}.png`;

                if (Object.keys(stats).length === 0) {
                    container.innerHTML = "<p>Detailed stats not available for this team yet.</p>";
                    initRadarChart({}); // Default
                } else {
                    container.innerHTML = '';
                    for (const [key, val] of Object.entries(stats)) {
                        const div = document.createElement('div');
                        div.className = 'stat-item';
                        div.innerHTML = `<span>${key}</span><span class="stat-value">${val}</span>`;
                        container.appendChild(div);
                    }
                    initRadarChart(stats);
                }

                // Generate Heatmap Dots based on position
                generateHeatmap(playerPos);

            } catch (error) {
                container.innerHTML = "<p>Error loading details.</p>";
            }
        }

        function initRadarChart(stats) {
            const ctx = document.getElementById('player-radar').getContext('2d');

            // Map stats to standard categories or use defaults
            const labels = ['Attack', 'Creation', 'Defense', 'Passing', 'Physical', 'Discipline'];

            // Simulation of normalizing stats (0-100)
            const getVal = (key, def) => {
                const val = stats[key] || stats[key.toLowerCase()];
                if (!val) return def;
                const num = parseFloat(val.toString().replace('%', ''));
                return isNaN(num) ? def : (num > 100 ? 100 : num);
            };

            const data = [
                getVal('Goals', 10) * 5, // scaled for weight
                getVal('Assists', 5) * 10,
                getVal('Tackles', 40),
                getVal('Pass accuracy', 70),
                getVal('Appearances', 15) * 2,
                100 - getVal('Yellow cards', 0) * 10
            ];

            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Performance Profile',
                        data: data,
                        fill: true,
                        backgroundColor: 'rgba(255, 122, 0, 0.2)',
                        borderColor: 'rgb(255, 122, 0)',
                        pointBackgroundColor: 'rgb(255, 122, 0)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(255, 122, 0)'
                    }]
                },
                options: {
                    elements: { line: { borderWidth: 3 } },
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            pointLabels: { color: '#94a3b8', font: { size: 12 } },
                            ticks: { display: false, max: 100, min: 0 }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        async function generateHeatmap(pos) {
            const container = document.getElementById('heatmap-svg-container');
            try {
                const response = await fetch(`/api/heatmap?pos=${encodeURIComponent(pos)}`);
                const svgText = await response.text();
                container.innerHTML = svgText;
            } catch (error) {
                container.innerHTML = "<p>Error loading Matplotlib heatmap.</p>";
            }
        }

        let currentGraphMode = 'rating';

        async function loadRatingGraph(name) {
            const container = document.getElementById('rating-graph-container');
            try {
                const response = await fetch(`/api/rating-graph?name=${encodeURIComponent(name)}&mode=${currentGraphMode}`);
                const svgText = await response.text();
                container.innerHTML = svgText;

                // Add click listener every time SVG is re-injected
                container.onclick = () => {
                    currentGraphMode = currentGraphMode === 'rating' ? 'count' : 'rating';
                    loadRatingGraph(name);
                };
            } catch (error) {
                container.innerHTML = "<p>Error loading rating graph.</p>";
            }
        }

        loadDetails();
        loadRatingGraph(playerName);

        // Parallax Effect
        document.addEventListener('mousemove', (e) => {
            const glow = document.querySelector('.bg-glow');
            const x = (window.innerWidth / 2 - e.pageX) / 50;
            const y = (window.innerHeight / 2 - e.pageY) / 50;
            glow.style.transform = `translate(${x}px, ${y}px) rotate(${Date.now() / 1000}deg)`;
        });
    </script>
</body>

</html>